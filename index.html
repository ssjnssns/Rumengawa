<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æ—¶é—´æ°´å°å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* å±…ä¸Šå¯¹é½ */
            min-height: 100vh;
            background-color: #f0f2f5;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            width: 90%;
            max-width: 800px;
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 25px;
            font-size: 28px;
            font-weight: 600;
        }

        input[type="file"] {
            margin-bottom: 20px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: block;
            width: calc(100% - 24px);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            background-color: #fdfdfd;
            cursor: pointer;
        }
        input[type="file"]::-webkit-file-upload-button {
            visibility: hidden;
        }
        input[type="file"]::before {
            content: 'é€‰æ‹©å›¾ç‰‡';
            display: inline-block;
            background: linear-gradient(to bottom, #f9f9f9, #e3e3e3);
            border: 1px solid #999;
            border-radius: 6px;
            padding: 8px 16px;
            outline: none;
            white-space: nowrap;
            -webkit-user-select: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            color: #444;
        }
        input[type="file"]:hover::before {
            border-color: black;
        }
        input[type="file"]:active::before {
            background: -webkit-linear-gradient(top, #e3e3e3, #f9f9f9);
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 0 10px 10px 0; /* ç•™ä¸€ç‚¹é—´è· */
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #watermarkText {
            width: calc(100% - 20px);
            max-width: 300px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 14px;
        }

        #outputContainer {
            margin-top: 30px;
            border: 1px dashed #ccc;
            padding: 20px;
            border-radius: 10px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fafafa;
            overflow: hidden; /* é˜²æ­¢å›¾ç‰‡æº¢å‡º */
            position: relative;
        }

        #outputCanvas {
            max-width: 100%;
            height: auto;
            display: block; /* ç§»é™¤ canvas ä¸‹æ–¹å¯èƒ½å­˜åœ¨çš„ç©ºç™½ */
            border-radius: 8px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap; /* æŒ‰é’®è¿‡å¤šæ—¶æ¢è¡Œ */
            justify-content: center;
            margin-top: 20px;
        }
        .control-group {
            margin: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .control-group label {
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }
        .control-group input[type="number"],
        .control-group input[type="text"],
        .control-group select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            width: 120px;
            max-width: 100%;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px; /* å®½åº¦ */
            height: 24px; /* é«˜åº¦ */
            margin-left: 10px;
            vertical-align: middle;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px; /* æ»‘å—é«˜åº¦ */
            width: 16px; /* æ»‘å—å®½åº¦ */
            left: 4px; /* åˆå§‹å·¦è¾¹è· */
            bottom: 4px; /* åˆå§‹åº•éƒ¨è¾¹è· */
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3; /* é€‰ä¸­æ—¶çš„é¢œè‰² */
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(20px); /* æ»‘å—ç§»åŠ¨è·ç¦» (å®½åº¦ - æ»‘å—å®½åº¦ - 2*è¾¹è·) */
        }

        .datetime-picker-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .datetime-picker-group label {
            margin-right: 10px;
            font-size: 15px;
            color: #555;
            flex-shrink: 0;
        }
        .datetime-picker-group input[type="date"],
        .datetime-picker-group input[type="time"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            margin-right: 10px;
            flex-grow: 1; /* å…è®¸è¾“å…¥æ¡†å¢é•¿ */
            max-width: 150px;
        }

        .footer {
            margin-top: 30px;
            font-size: 14px;
            color: #777;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ“¸ å›¾ç‰‡æ—¶é—´æ°´å°å·¥å…·</h1>
        
        <input type="file" id="imageInput" accept="image/*">
        
        <div class="datetime-picker-group">
            <label for="useCurrentTime">ä½¿ç”¨å½“å‰æ—¶é—´:</label>
            <label class="toggle-switch">
                <input type="checkbox" id="useCurrentTime" checked>
                <span class="slider"></span>
            </label>
            <input type="date" id="setDate" style="display: none;">
            <input type="time" id="setTime" style="display: none;">
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="watermarkText">è‡ªå®šä¹‰æ–‡å­— (å¯é€‰):</label>
                <input type="text" id="watermarkText" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç¾å¥½ç¬é—´">
            </div>
            <div class="control-group">
                <label for="fontSize">å­—ä½“å¤§å° (px):</label>
                <input type="number" id="fontSize" value="16" min="8" max="100">
            </div>
            <div class="control-group">
                <label for="fontColor">å­—ä½“é¢œè‰²:</label>
                <input type="text" id="fontColor" value="#FFFFFF" placeholder="#RRGGBB æˆ– color name">
            </div>
            <div class="control-group">
                <label for="positionX">Xè½´åç§» (%):</label>
                <input type="number" id="positionX" value="50" min="0" max="100">
            </div>
            <div class="control-group">
                <label for="positionY">Yè½´åç§» (%):</label>
                <input type="number" id="positionY" value="95" min="0" max="100">
            </div>
            <div class="control-group">
                <label for="alignment">æ–‡å­—å¯¹é½:</label>
                <select id="alignment">
                    <option value="center">å±…ä¸­</option>
                    <option value="left">é å·¦</option>
                    <option value="right">é å³</option>
                </select>
            </div>
        </div>

        <button id="addWatermarkBtn" disabled>æ·»åŠ æ°´å°å¹¶é¢„è§ˆ</button>
        <button id="downloadBtn" disabled>ä¸‹è½½å¸¦æ°´å°çš„å›¾ç‰‡</button>
    </div>

    <div id="outputContainer">
        <canvas id="outputCanvas"></canvas>
        <p id="placeholderText">è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡å¼€å§‹</p>
    </div>

    <div class="footer">
        <p>åŸºäº HTML5 Canvas å’Œ JavaScript æ„å»ºï¼Œæ‰€æœ‰å¤„ç†å‡åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆã€‚</p>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const useCurrentTimeToggle = document.getElementById('useCurrentTime');
        const setDateInput = document.getElementById('setDate');
        const setTimeInput = document.getElementById('setTime');
        const watermarkTextCustom = document.getElementById('watermarkText');
        const fontSizeInput = document.getElementById('fontSize');
        const fontColorInput = document.getElementById('fontColor');
        const positionXInput = document.getElementById('positionX');
        const positionYInput = document.getElementById('positionY');
        const alignmentSelect = document.getElementById('alignment');
        const addWatermarkBtn = document.getElementById('addWatermarkBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const outputCanvas = document.getElementById('outputCanvas');
        const ctx = outputCanvas.getContext('2d');
        const placeholderText = document.getElementById('placeholderText');

        let originalImage = null; // ç”¨äºå­˜å‚¨åŸå§‹å›¾ç‰‡å¯¹è±¡

        // è·å–å½“å‰æ—¥æœŸå’Œæ—¶é—´å¹¶æ ¼å¼åŒ–
        function getFormattedDateTime(dateObj) {
            const year = dateObj.getFullYear();
            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const day = dateObj.getDate().toString().padStart(2, '0');
            const hours = dateObj.getHours().toString().padStart(2, '0');
            const minutes = dateObj.getMinutes().toString().padStart(2, '0');
            return `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
        }

        // åˆå§‹åŒ–æ—¥æœŸå’Œæ—¶é—´é€‰æ‹©å™¨ä¸ºå½“å‰æ—¶é—´
        function initializeDateTimePickers() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');

            setDateInput.value = `${year}-${month}-${day}`;
            setTimeInput.value = `${hours}:${minutes}`;
        }
        initializeDateTimePickers();

        // æ ¹æ® useCurrentTime åˆ‡æ¢è‡ªå®šä¹‰æ—¥æœŸ/æ—¶é—´çš„æ˜¾ç¤º
        useCurrentTimeToggle.addEventListener('change', () => {
            if (useCurrentTimeToggle.checked) {
                setDateInput.style.display = 'none';
                setTimeInput.style.display = 'none';
            } else {
                setDateInput.style.display = 'inline-block';
                setTimeInput.style.display = 'inline-block';
            }
            if (originalImage) {
                addWatermark(); // æ›´æ”¹æ—¶é—´è®¾ç½®åç«‹å³æ›´æ–°é¢„è§ˆ
            }
        });

        // ç›‘å¬å›¾ç‰‡æ–‡ä»¶é€‰æ‹©
        imageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        originalImage = img; // ä¿å­˜åŸå§‹å›¾ç‰‡
                        placeholderText.style.display = 'none';
                        addWatermarkBtn.disabled = false;
                        addWatermark(); // åŠ è½½åç«‹å³æ·»åŠ æ°´å°
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                originalImage = null;
                addWatermarkBtn.disabled = true;
                downloadBtn.disabled = true;
                ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
                placeholderText.style.display = 'block';
                outputCanvas.style.width = 'auto'; // æ¸…é™¤é¢„è§ˆå°ºå¯¸
                outputCanvas.style.height = 'auto';
            }
        });

        // æ·»åŠ æ°´å°æ ¸å¿ƒé€»è¾‘
        function addWatermark() {
            if (!originalImage) {
                return;
            }

            // è®¾ç½® Canvas å°ºå¯¸ä¸å›¾ç‰‡ä¸€è‡´
            outputCanvas.width = originalImage.naturalWidth;
            outputCanvas.height = originalImage.naturalHeight;

            // æ¸…é™¤ Canvas å¹¶ç»˜åˆ¶åŸå§‹å›¾ç‰‡
            ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
            ctx.drawImage(originalImage, 0, 0);

            // è·å–æ—¶é—´å­—ç¬¦ä¸²
            let dateTimeString;
            if (useCurrentTimeToggle.checked) {
                dateTimeString = getFormattedDateTime(new Date());
            } else {
                const dateVal = setDateInput.value;
                const timeVal = setTimeInput.value;
                if (dateVal && timeVal) {
                    const customDate = new Date(`${dateVal}T${timeVal}:00`);
                    dateTimeString = getFormattedDateTime(customDate);
                } else {
                    dateTimeString = "æ— æ•ˆæ—¶é—´"; // ç¡®ä¿æœ‰é»˜è®¤å€¼
                }
            }

            // è·å–è‡ªå®šä¹‰æ–‡å­—
            const customText = watermarkTextCustom.value.trim();
            let finalWatermarkText = dateTimeString;
            if (customText) {
                finalWatermarkText += ` ${customText}`; // å¦‚æœæœ‰è‡ªå®šä¹‰æ–‡å­—ï¼ŒåŠ åœ¨æ—¥æœŸåé¢
            }

            // è®¾ç½®æ°´å°æ ·å¼
            const fontSize = parseInt(fontSizeInput.value) || 16;
            const fontColor = fontColorInput.value || '#FFFFFF';
            const alignment = alignmentSelect.value || 'center';
            
            // è®¡ç®—å­—ä½“å¤§å°ï¼Œä½¿å…¶åœ¨ä¸åŒåˆ†è¾¨ç‡å›¾ç‰‡ä¸Šçœ‹èµ·æ¥å·®ä¸å¤š
            // å‡è®¾ä¸€ä¸ªåŸºå‡†å®½åº¦ (ä¾‹å¦‚ 1920px)ï¼Œåœ¨è¿™ä¸ªå®½åº¦ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›å­—ä½“æ˜¯ 16px
            // é‚£ä¹ˆå®é™…å­—ä½“å¤§å° = (å½“å‰å›¾ç‰‡å®½åº¦ / 1920) * æœŸæœ›å­—ä½“å¤§å°
            const dynamicFontSize = Math.max(8, (outputCanvas.width / 1920) * fontSize); // æœ€å°8pxé˜²æ­¢è¿‡å°

            ctx.font = `${dynamicFontSize}px sans-serif`; // å­—ä½“è®¾ç½®
            ctx.fillStyle = fontColor; // é¢œè‰²
            ctx.textAlign = alignment; // å¯¹é½æ–¹å¼
            ctx.textBaseline = 'bottom'; // æ–‡æœ¬åŸºçº¿è®¾ç½®ä¸ºåº•éƒ¨ï¼Œæ–¹ä¾¿å®šä½

            // è®¡ç®—æ°´å°ä½ç½®
            const margin = dynamicFontSize; // è¾¹è·ä¸å­—ä½“å¤§å°ç›¸å…³
            let x, y;
            const positionX = parseInt(positionXInput.value) / 100;
            const positionY = parseInt(positionYInput.value) / 100;

            if (alignment === 'left') {
                x = margin; // è·ç¦»å·¦è¾¹è·
            } else if (alignment === 'right') {
                x = outputCanvas.width - margin; // è·ç¦»å³è¾¹è·
            } else { // center
                x = outputCanvas.width * positionX; // ç›¸å¯¹Xè½´ç™¾åˆ†æ¯”
            }
            y = outputCanvas.height * positionY; // ç›¸å¯¹Yè½´ç™¾åˆ†æ¯”

            // ç»˜åˆ¶æ°´å°
            ctx.fillText(finalWatermarkText, x, y);

            // è°ƒæ•´ canvas é¢„è§ˆå¤§å° (ä¸ºäº†åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºä¸è‡³äºå¤ªå¤§)
            const maxWidth = 700; // æœ€å¤§é¢„è§ˆå®½åº¦
            if (outputCanvas.width > maxWidth) {
                outputCanvas.style.width = maxWidth + 'px';
                outputCanvas.style.height = 'auto';
            } else {
                outputCanvas.style.width = 'auto';
                outputCanvas.style.height = 'auto';
            }

            downloadBtn.disabled = false; // é¢„è§ˆæˆåŠŸåï¼Œä¸‹è½½æŒ‰é’®å¯ç”¨
        }

        // ä¸‹è½½å¸¦æ°´å°çš„å›¾ç‰‡
        downloadBtn.addEventListener('click', function() {
            if (originalImage) {
                // å°† Canvas å†…å®¹è½¬æ¢ä¸º Data URL
                const dataURL = outputCanvas.toDataURL('image/png'); // å¯ä»¥æ”¹ä¸º 'image/jpeg'

                // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿé“¾æ¥ç”¨äºä¸‹è½½
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = `watermarked_image_${Date.now()}.png`; // é»˜è®¤æ–‡ä»¶å
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        });

        // ç›‘å¬å‚æ•°å˜åŒ–ï¼Œå®æ—¶æ›´æ–°æ°´å°é¢„è§ˆ
        addWatermarkBtn.addEventListener('click', addWatermark);
        fontSizeInput.addEventListener('change', addWatermark);
        fontColorInput.addEventListener('change', addWatermark);
        positionXInput.addEventListener('change', addWatermark);
        positionYInput.addEventListener('change', addWatermark);
        alignmentSelect.addEventListener('change', addWatermark);
        watermarkTextCustom.addEventListener('input', addWatermark); // è¾“å…¥æ—¶æ›´æ–°
        setDateInput.addEventListener('change', addWatermark);
        setTimeInput.addEventListener('change', addWatermark);
    </script>

</body>
</html>
