<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¤ªç©ºå…¥ä¾µè€…ï¼šå¢å¼ºç‰ˆ</title>
    <style>
        body {
            font-family: 'Press Start 2P', cursive, 'Pixelmix', Arial, sans-serif; /* å°è¯•ä½¿ç”¨åƒç´ å­—ä½“ */
            background-color: #0d0d1a;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            height: 100vh;
            overflow: hidden; /* é˜²æ­¢æ»šåŠ¨æ¡ */
        }
        @font-face { /* å¼•å…¥åƒç´ å­—ä½“ï¼Œå¦‚æœæœ¬åœ°æ²¡æœ‰åˆ™ç”¨å¤‡ç”¨ */
            font-family: 'Press Start 2P';
            src: url('https://fonts.gstatic.com/s/pressstart2p/v14/8Lg6dHw-tglw6wJzF_Yqxfc6Yx99.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
        }
        h1 {
            color: #6a5acd; /* ç´«ç½—å…°è‰² */
            text-shadow: 0 0 15px #6a5acd, 0 0 30px #483d8b;
            margin-bottom: 20px;
            font-size: 2.5em;
        }
        #game-container {
            border: 3px solid #6a5acd;
            box-shadow: 0 0 25px rgba(106, 90, 205, 0.8), 0 0 50px rgba(72, 61, 139, 0.5);
            position: relative;
            background-color: #000; /* CanvasèƒŒæ™¯è‰²ï¼Œå®é™…ç”±æ»šåŠ¨èƒŒæ™¯è¦†ç›– */
            overflow: hidden;
        }
        canvas {
            display: block;
            background-color: transparent; /* è®©èƒŒæ™¯æ˜Ÿç©ºå¯è§ */
        }
        #game-controls {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap; /* æŒ‰é’®è¿‡å¤šæ—¶æ¢è¡Œ */
            justify-content: center;
        }
        button {
            background-color: #3a3a5a;
            color: #e0e0e0;
            border: 2px solid #6a5acd;
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            border-radius: 5px;
            font-family: 'Press Start 2P', cursive, Arial, sans-serif;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        button:hover {
            background-color: #4a4a6a;
            border-color: #8a7acd;
            box-shadow: 0 0 15px rgba(138, 122, 205, 0.7);
        }
        button.active {
            background-color: #d2691e; /* å·§å…‹åŠ›è‰² */
            border-color: #ff8c00; /* æš—æ©™è‰² */
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.8);
        }
        button#cheat-btn.active {
            background-color: #a52a2a; /* æ£•è‰² */
            border-color: #ff4500; /* æ©™çº¢è‰² */
            box-shadow: 0 0 15px rgba(255, 69, 0, 0.8);
        }
        #info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-size: 1.1em;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
            line-height: 1.5;
            z-index: 10;
        }
        #boss-health-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 20px;
            background-color: #555;
            border: 2px solid #888;
            border-radius: 5px;
            overflow: hidden;
            opacity: 0; /* é»˜è®¤éšè— */
            transition: opacity 0.5s ease-in-out;
            z-index: 10;
        }
        #boss-health-bar.active {
            opacity: 1;
        }
        #boss-health-fill {
            height: 100%;
            background: linear-gradient(to right, #ff4500, #ff8c00);
            width: 100%; /* åˆå§‹æ»¡è¡€ */
            transition: width 0.1s linear;
        }
        #boss-name {
            position: absolute;
            top: -25px;
            width: 100%;
            text-align: center;
            color: #ff4500;
            font-size: 1.2em;
            text-shadow: 0 0 10px #ff4500;
        }
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle 4s infinite ease-in-out;
            z-index: -1;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>

    <h1>ğŸš€ å¤ªç©ºå…¥ä¾µè€…ï¼šå¢å¼ºç‰ˆ ğŸ‘½</h1>
    
    <div id="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="info-panel">
            åˆ†æ•°: <span id="score-display">0</span><br>
            ç”Ÿå‘½: <span id="lives-display">3</span>
        </div>
        <div id="boss-health-bar">
            <div id="boss-name">é¢†ä¸» åŸºå°”åŠ ä¸¹</div>
            <div id="boss-health-fill"></div>
        </div>
    </div>
    
    <div id="game-controls">
        <button id="start-btn">å¼€å§‹æ¸¸æˆ</button>
        <button id="mode-select">æ¨¡å¼: æ™®é€š</button>
        <button id="cheat-btn">ä½œå¼Šæ¨¡å¼ (å…³)</button>
    </div>

    <script>
        // --- ç”»å¸ƒå’Œä¸Šä¸‹æ–‡ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- DOMå…ƒç´  ---
        const scoreDisplay = document.getElementById('score-display');
        const livesDisplay = document.getElementById('lives-display');
        const startBtn = document.getElementById('start-btn');
        const modeSelectBtn = document.getElementById('mode-select');
        const cheatBtn = document.getElementById('cheat-btn');
        const bossHealthBar = document.getElementById('boss-health-bar');
        const bossHealthFill = document.getElementById('boss-health-fill');

        // --- æ¸¸æˆå¸¸é‡å’Œé…ç½® ---
        const GAME_WIDTH = canvas.width;
        const GAME_HEIGHT = canvas.height;
        const PLAYER_COLOR = '#00ffff'; // é’è‰²
        const ENEMY_COLORS = ['#ff0000', '#ffa500', '#ffff00']; // çº¢ã€æ©™ã€é»„
        const BULLET_COLOR = '#00ff00'; // ç»¿è‰²
        const ENEMY_BULLET_COLOR = '#ff00ff'; // å“çº¢è‰²
        const POWERUP_COLOR = '#ffffff'; // ç™½è‰²
        const BOSS_COLOR = '#8b008b'; // æš—ç´«è‰²

        const GAME_STATE = {
            MENU: 'menu',
            PLAYING: 'playing',
            GAME_OVER: 'gameOver',
            WIN: 'win'
        };

        // --- æ¸¸æˆå˜é‡ ---
        let currentState = GAME_STATE.MENU;
        let score = 0;
        let lives = 3;
        let gameMode = 'normal'; // 'normal', 'hard'
        let isCheating = false;

        let player;
        let bullets = [];         // ç©å®¶å­å¼¹
        let enemyBullets = [];    // æ•Œäººå­å¼¹å’ŒBosså­å¼¹
        let enemies = [];
        let powerups = [];
        let boss = null;
        let stars = [];           // èƒŒæ™¯æ˜Ÿæ˜Ÿ
        let starScrollOffset = 0;

        let keys = {}; // å­˜å‚¨æŒ‰é”®çŠ¶æ€

        let enemySpawnTimer = 0;
        let enemySpawnInterval = 120; // å¸§æ•°
        let currentWave = 0;
        const BOSS_TRIGGER_SCORE = 5000; // è¾¾åˆ°æ­¤åˆ†æ•°è§¦å‘Boss

        // ç©å®¶èƒ½åŠ›
        let playerAbility = {
            rapidFire: false,
            multiShot: false,
            invincible: false,
            oneHitKill: false, // ä½œå¼Šæ¨¡å¼
            rapidFireTimer: 0,
            multiShotTimer: 0
        };

        // --- æ¸¸æˆå¯¹è±¡ç±» ---

        class Entity {
            constructor(x, y, width, height, color, speed) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
                this.speed = speed;
                this.markedForDeletion = false;
            }

            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
        }

        class Player extends Entity {
            constructor() {
                super(GAME_WIDTH / 2 - 25, GAME_HEIGHT - 60, 50, 50, PLAYER_COLOR, 6);
                this.cooldown = 0;
                this.maxCooldown = 20; // æ­£å¸¸å°„å‡»é—´éš”
            }

            update() {
                if (keys['ArrowLeft'] && this.x > 0) this.x -= this.speed;
                if (keys['ArrowRight'] && this.x < GAME_WIDTH - this.width) this.x += this.speed;
                if (keys['ArrowUp'] && this.y > GAME_HEIGHT / 2) this.y -= this.speed; // é™åˆ¶Yè½´ç§»åŠ¨èŒƒå›´
                if (keys['ArrowDown'] && this.y < GAME_HEIGHT - this.height) this.y += this.speed;


                if (this.cooldown > 0) this.cooldown--;

                let currentShotCooldown = playerAbility.rapidFire ? 7 : this.maxCooldown;
                if (isCheating && playerAbility.rapidFire) currentShotCooldown = 3; // ä½œå¼Šæ¨¡å¼ä¸‹æ›´å¿«

                if ((keys[' '] || keys['Spacebar']) && this.cooldown === 0) {
                    if (playerAbility.multiShot) {
                        bullets.push(new Bullet(this.x + this.width / 2 - 2.5, this.y, 0, -10)); // ä¸­
                        bullets.push(new Bullet(this.x + this.width / 2 - 15, this.y, -3, -10)); // å·¦
                        bullets.push(new Bullet(this.x + this.width / 2 + 10, this.y, 3, -10));  // å³
                    } else {
                        bullets.push(new Bullet(this.x + this.width / 2 - 2.5, this.y, 0, -10));
                    }
                    this.cooldown = currentShotCooldown;
                }
                
                // æ›´æ–°èƒ½åŠ›è®¡æ—¶å™¨
                if (playerAbility.rapidFireTimer > 0) playerAbility.rapidFireTimer--;
                else playerAbility.rapidFire = false;

                if (playerAbility.multiShotTimer > 0) playerAbility.multiShotTimer--;
                else playerAbility.multiShot = false;
            }

            draw(ctx) {
                // ç»˜åˆ¶ä¸€ä¸ªå°–å¤´é£èˆ¹
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(this.x + this.width / 2, this.y); // é¡¶éƒ¨å°–ç‚¹
                ctx.lineTo(this.x, this.y + this.height);    // å·¦ä¸‹è§’
                ctx.lineTo(this.x + this.width / 2, this.y + this.height * 0.8); // åº•éƒ¨å‡¹æ§½ä¸­é—´
                ctx.lineTo(this.x + this.width, this.y + this.height); // å³ä¸‹è§’
                ctx.closePath();
                ctx.fill();

                // åº•éƒ¨å–·å°„å™¨ç«ç„°æ•ˆæœ
                ctx.fillStyle = '#ff8c00'; // æ©™è‰²
                ctx.beginPath();
                ctx.moveTo(this.x + this.width * 0.2, this.y + this.height);
                ctx.lineTo(this.x + this.width * 0.8, this.y + this.height);
                ctx.lineTo(this.x + this.width / 2, this.y + this.height + 15);
                ctx.closePath();
                ctx.fill();

                if (playerAbility.invincible) {
                    ctx.strokeStyle = '#ffff00';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(this.x + this.width / 2, this.y + this.height / 2, this.width * 0.8, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
        }

        class Bullet extends Entity {
            constructor(x, y, vx, vy) {
                super(x, y, 5, 15, BULLET_COLOR, Math.abs(vy));
                this.vx = vx;
                this.vy = vy;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.y < -this.height || this.y > GAME_HEIGHT || this.x < -this.width || this.x > GAME_WIDTH) {
                    this.markedForDeletion = true;
                }
            }

            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 10;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.shadowBlur = 0; // åŠæ—¶å…³é—­é˜´å½±
            }
        }

        class EnemyBullet extends Bullet {
            constructor(x, y, vx, vy) {
                super(x, y, vx, vy);
                this.color = ENEMY_BULLET_COLOR;
            }
        }

        class Enemy extends Entity {
            constructor(x, y, speed, type) {
                // type 0: å¼± (çº¢), 1: ä¸­ (æ©™), 2: å¼º (é»„)
                const width = 40;
                const height = 30;
                super(x, y, width, height, ENEMY_COLORS[type], speed);
                this.health = type + 1; // å¯¹åº”ç”Ÿå‘½å€¼
                this.shotCooldown = Math.random() * 100 + 100; // å°„å‡»é—´éš”
                this.movingLeft = Math.random() > 0.5; // åˆå§‹ç§»åŠ¨æ–¹å‘
                this.xMovementSpeed = speed * 0.5;
                this.yMovementSpeed = speed * 0.1;
                this.scoreValue = (type + 1) * 50;
            }

            update() {
                // å·¦å³ç§»åŠ¨
                if (this.movingLeft) {
                    this.x -= this.xMovementSpeed;
                    if (this.x < 0) {
                        this.movingLeft = false;
                        this.x = 0;
                    }
                } else {
                    this.x += this.xMovementSpeed;
                    if (this.x > GAME_WIDTH - this.width) {
                        this.movingLeft = false;
                        this.x = GAME_WIDTH - this.width;
                    }
                }
                
                // ç¼“æ…¢å‘ä¸‹ç§»åŠ¨
                this.y += this.yMovementSpeed;

                // å°„å‡»
                if (this.shotCooldown <= 0) {
                    if (Math.random() < 0.02 * (gameMode === 'hard' ? 2 : 1)) { // å›°éš¾æ¨¡å¼å°„å‡»å‡ ç‡æ›´é«˜
                        enemyBullets.push(new EnemyBullet(this.x + this.width / 2 - 2.5, this.y + this.height, 0, 5));
                    }
                    this.shotCooldown = Math.random() * 200 + 100;
                } else {
                    this.shotCooldown--;
                }

                if (this.y > GAME_HEIGHT) {
                    this.markedForDeletion = true; // é£å‡ºå±å¹•
                }
            }

            draw(ctx) {
                // ç»˜åˆ¶ä¸€ä¸ªå¤–æ˜Ÿé£èˆ¹å½¢çŠ¶
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.ellipse(this.x + this.width / 2, this.y + this.height * 0.6, this.width / 2, this.height * 0.4, 0, 0, Math.PI * 2);
                ctx.fill();

                ctx.beginPath();
                ctx.moveTo(this.x, this.y + this.height * 0.6);
                ctx.lineTo(this.x + this.width / 2, this.y);
                ctx.lineTo(this.x + this.width, this.y + this.height * 0.6);
                ctx.fill();

                // çœ¼ç›
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(this.x + this.width * 0.3, this.y + this.height * 0.4, 3, 0, Math.PI * 2);
                ctx.arc(this.x + this.width * 0.7, this.y + this.height * 0.4, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        class Boss extends Entity {
            constructor() {
                super(GAME_WIDTH / 2 - 75, 50, 150, 100, BOSS_COLOR, 1.5);
                this.maxHealth = 50 + (gameMode === 'hard' ? 50 : 0);
                this.health = this.maxHealth;
                this.shotCooldown = 60;
                this.moveTimer = 0;
                this.moveDirection = 1; // 1:å³, -1:å·¦
                this.scoreValue = 5000;
            }

            update() {
                // å·¦å³ç§»åŠ¨
                this.x += this.speed * this.moveDirection;
                if (this.x < 0 || this.x > GAME_WIDTH - this.width) {
                    this.moveDirection *= -1;
                }

                // å°„å‡» (å¤šå‘å­å¼¹)
                if (this.shotCooldown <= 0) {
                    // ä¸­å¿ƒå°„å‡»
                    enemyBullets.push(new EnemyBullet(this.x + this.width / 2 - 2.5, this.y + this.height, 0, 7));
                    // æ–œå‘å°„å‡»
                    enemyBullets.push(new EnemyBullet(this.x + this.width / 2 - 30, this.y + this.height, -2, 7));
                    enemyBullets.push(new EnemyBullet(this.x + this.width / 2 + 25, this.y + this.height, 2, 7));
                    this.shotCooldown = 60 + (gameMode === 'hard' ? 0 : 30); // å›°éš¾æ¨¡å¼å°„é€Ÿæ›´å¿«
                } else {
                    this.shotCooldown--;
                }
                
                // æ›´æ–°è¡€æ¡UI
                bossHealthFill.style.width = `${(this.health / this.maxHealth) * 100}%`;
                if (!bossHealthBar.classList.contains('active')) {
                    bossHealthBar.classList.add('active');
                }
            }

            draw(ctx) {
                // ç»˜åˆ¶ä¸€ä¸ªæ›´å¤æ‚çš„Bossé£èˆ¹
                ctx.fillStyle = this.color;
                ctx.shadowColor = BOSS_COLOR;
                ctx.shadowBlur = 20;

                // ä¸»ä½“
                ctx.beginPath();
                ctx.moveTo(this.x + this.width / 2, this.y);
                ctx.lineTo(this.x, this.y + this.height * 0.8);
                ctx.lineTo(this.x + this.width * 0.2, this.y + this.height);
                ctx.lineTo(this.x + this.width * 0.8, this.y + this.height);
                ctx.lineTo(this.x + this.width, this.y + this.height * 0.8);
                ctx.closePath();
                ctx.fill();

                // çœ¼ç›/æ ¸å¿ƒ
                ctx.fillStyle = '#ff0000'; // çº¢è‰²æ ¸å¿ƒ
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y + this.height * 0.5, 15, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;

                // å°ç‚®å°
                ctx.fillStyle = '#4b0082'; // é›é’è‰²
                ctx.fillRect(this.x + this.width * 0.1, this.y + this.height * 0.9, 10, 15);
                ctx.fillRect(this.x + this.width * 0.9 - 10, this.y + this.height * 0.9, 10, 15);
            }
        }

        class PowerUp extends Entity {
            constructor(x, y, type) {
                super(x, y, 20, 20, POWERUP_COLOR, 2);
                this.type = type; // 'rapidFire', 'multiShot', 'health'
                this.color = this.getTypeColor();
            }

            getTypeColor() {
                switch (this.type) {
                    case 'rapidFire': return '#ff00ff'; // å“çº¢è‰²
                    case 'multiShot': return '#00ff00'; // ç»¿è‰²
                    case 'health': return '#ff0000';    // çº¢è‰²
                    default: return POWERUP_COLOR;
                }
            }

            update() {
                this.y += this.speed;
                if (this.y > GAME_HEIGHT) {
                    this.markedForDeletion = true;
                }
            }

            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 15;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.shadowBlur = 0;
            }
        }

        // --- åˆå§‹åŒ–æ¸¸æˆ ---
        function initGame() {
            score = 0;
            lives = 3;
            player = new Player();
            bullets = [];
            enemyBullets = [];
            enemies = [];
            powerups = [];
            boss = null;
            currentWave = 0;
            enemySpawnTimer = 0;

            // é‡ç½®ç©å®¶èƒ½åŠ›
            playerAbility = {
                rapidFire: isCheating,
                multiShot: false,
                invincible: isCheating,
                oneHitKill: isCheating,
                rapidFireTimer: 0,
                multiShotTimer: 0
            };
            
            // éšè—Bossè¡€æ¡
            bossHealthBar.classList.remove('active');

            currentState = GAME_STATE.PLAYING;
            updateUI();
            generateStars();
        }

        // --- ç”ŸæˆèƒŒæ™¯æ˜Ÿæ˜Ÿ ---
        function generateStars() {
            stars = [];
            for (let i = 0; i < 100; i++) {
                stars.push({
                    x: Math.random() * GAME_WIDTH,
                    y: Math.random() * GAME_HEIGHT,
                    size: Math.random() * 2 + 1,
                    speed: Math.random() * 0.5 + 0.1 // ä¸åŒçš„é€Ÿåº¦åˆ¶é€ æ™¯æ·±
                });
            }
        }

        // --- æ›´æ–°æ¸¸æˆçŠ¶æ€ ---
        function update() {
            if (currentState !== GAME_STATE.PLAYING) return;

            // æ›´æ–°èƒŒæ™¯æ˜Ÿæ˜Ÿ
            starScrollOffset += 0.5;
            if (starScrollOffset >= GAME_HEIGHT) starScrollOffset = 0;

            stars.forEach(star => {
                star.y += star.speed;
                if (star.y > GAME_HEIGHT) {
                    star.y = 0;
                    star.x = Math.random() * GAME_WIDTH;
                }
            });

            player.update();

            // æ›´æ–°ç©å®¶å­å¼¹
            bullets.forEach(bullet => bullet.update());
            bullets = bullets.filter(bullet => !bullet.markedForDeletion);

            // æ›´æ–°æ•Œäºº
            enemies.forEach(enemy => enemy.update());
            enemies = enemies.filter(enemy => !enemy.markedForDeletion);

            // æ›´æ–°æ•Œæ–¹å­å¼¹
            enemyBullets.forEach(bullet => bullet.update());
            enemyBullets = enemyBullets.filter(bullet => !bullet.markedForDeletion);

            // æ›´æ–°é“å…·
            powerups.forEach(powerup => powerup.update());
            powerups = powerups.filter(powerup => !powerup.markedForDeletion);

            // Bossæ›´æ–°
            if (boss) {
                boss.update();
                if (boss.health <= 0) {
                    score += boss.scoreValue;
                    boss.markedForDeletion = true;
                    boss = null;
                    bossHealthBar.classList.remove('active'); // éšè—è¡€æ¡
                    gameWin();
                    return;
                }
            }


            // æ•Œäººç”Ÿæˆ (å¦‚æœBossä¸å­˜åœ¨)
            if (!boss) {
                enemySpawnTimer++;
                if (enemySpawnTimer >= enemySpawnInterval) {
                    if (score < BOSS_TRIGGER_SCORE) { // è¾¾åˆ°Bossåˆ†æ•°å‰æŒç»­åˆ·æ€ª
                        spawnWave();
                        enemySpawnTimer = 0;
                        enemySpawnInterval = Math.max(60, enemySpawnInterval - 5); // é€æ¸åŠ å¿«åˆ·æ€ªé€Ÿåº¦
                    } else if (enemies.length === 0 && !boss) {
                        // è§¦å‘Bossæˆ˜
                        boss = new Boss();
                        enemySpawnInterval = 999999; // åœæ­¢åˆ·å°æ€ª
                    }
                }
            }
            

            // --- ç¢°æ’æ£€æµ‹ ---

            // ç©å®¶å­å¼¹ä¸æ•Œäºº
            for (let i = bullets.length - 1; i >= 0; i--) {
                for (let j = enemies.length - 1; j >= 0; j--) {
                    if (checkCollision(bullets[i], enemies[j])) {
                        bullets[i].markedForDeletion = true;
                        if (playerAbility.oneHitKill) {
                            enemies[j].health = 0; // ä¸€å‡»å¿…æ€
                        } else {
                             enemies[j].health--;
                        }
                       
                        if (enemies[j].health <= 0) {
                            score += enemies[j].scoreValue;
                            enemies[j].markedForDeletion = true;
                            // éšæœºæ‰è½é“å…·
                            if (Math.random() < 0.15) { // 15% å‡ ç‡æ‰è½
                                const type = ['rapidFire', 'multiShot', 'health'][Math.floor(Math.random() * 3)];
                                powerups.push(new PowerUp(enemies[j].x + enemies[j].width / 2, enemies[j].y + enemies[j].height / 2, type));
                            }
                        }
                        break;
                    }
                }
            }

            // ç©å®¶å­å¼¹ä¸Boss
            if (boss) {
                for (let i = bullets.length - 1; i >= 0; i--) {
                    if (checkCollision(bullets[i], boss)) {
                        bullets[i].markedForDeletion = true;
                        if (playerAbility.oneHitKill) {
                            boss.health -= 10; // Bossä¸èƒ½ä¸€å‡»å¿…æ€ï¼Œä½†å—æ›´å¤šä¼¤å®³
                        } else {
                            boss.health--;
                        }
                        break;
                    }
                }
            }

            // æ•Œæ–¹å­å¼¹ä¸ç©å®¶
            if (!playerAbility.invincible) { // ç©å®¶æ— æ•Œæ—¶ä¸å—ä¼¤
                for (let i = enemyBullets.length - 1; i >= 0; i--) {
                    if (checkCollision(enemyBullets[i], player)) {
                        enemyBullets[i].markedForDeletion = true;
                        lives--;
                        if (lives <= 0) {
                            gameOver();
                        }
                        break;
                    }
                }
            }

            // æ•Œäººä¸ç©å®¶
            if (!playerAbility.invincible) {
                for (let j = enemies.length - 1; j >= 0; j--) {
                    if (checkCollision(player, enemies[j])) {
                        enemies[j].markedForDeletion = true; // æ•Œäººæ’åˆ°ç©å®¶å°±æ¶ˆå¤±
                        lives--;
                        if (lives <= 0) {
                            gameOver();
                        }
                        break;
                    }
                }
            }

            // ç©å®¶ä¸é“å…·
            for (let i = powerups.length - 1; i >= 0; i--) {
                if (checkCollision(player, powerups[i])) {
                    activatePowerUp(powerups[i].type);
                    powerups[i].markedForDeletion = true;
                }
            }

            updateUI();
        }

        // --- ç”Ÿæˆä¸€æ³¢æ•Œäºº ---
        function spawnWave() {
            currentWave++;
            const numEnemies = Math.min(15, 5 + Math.floor(currentWave / 2));
            for (let i = 0; i < numEnemies; i++) {
                const enemyType = Math.floor(Math.random() * 3); // éšæœºç”Ÿæˆä¸åŒç±»å‹çš„æ•Œäºº
                const speed = (gameMode === 'hard' ? 1.5 : 1) * (1 + currentWave * 0.1);
                enemies.push(new Enemy(Math.random() * (GAME_WIDTH - 60) + 30, Math.random() * 100 - 150, speed, enemyType));
            }
        }

        // --- æ¿€æ´»é“å…·æ•ˆæœ ---
        function activatePowerUp(type) {
            switch (type) {
                case 'rapidFire':
                    playerAbility.rapidFire = true;
                    playerAbility.rapidFireTimer = 60 * 5; // æŒç»­5ç§’
                    break;
                case 'multiShot':
                    playerAbility.multiShot = true;
                    playerAbility.multiShotTimer = 60 * 7; // æŒç»­7ç§’
                    break;
                case 'health':
                    lives = Math.min(5, lives + 1); // æœ€å¤š5ç‚¹ç”Ÿå‘½
                    break;
            }
        }

        // --- ç¢°æ’æ£€æµ‹å‡½æ•° ---
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // --- ç»˜åˆ¶æ¸¸æˆ ---
        function draw() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

            // ç»˜åˆ¶èƒŒæ™¯æ˜Ÿæ˜Ÿ
            ctx.fillStyle = '#fff';
            stars.forEach(star => {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size / 2, 0, Math.PI * 2);
                ctx.fill();
            });

            // ç»˜åˆ¶æ‰€æœ‰å®ä½“
            player.draw(ctx);
            bullets.forEach(bullet => bullet.draw(ctx));
            enemyBullets.forEach(bullet => bullet.draw(ctx));
            enemies.forEach(enemy => enemy.draw(ctx));
            powerups.forEach(powerup => powerup.draw(ctx));
            if (boss) boss.draw(ctx);

            // æ ¹æ®æ¸¸æˆçŠ¶æ€ç»˜åˆ¶ç‰¹å®šUI
            if (currentState === GAME_STATE.MENU) {
                drawOverlay('å¤ªç©ºå…¥ä¾µè€…', 'æŒ‰ "å¼€å§‹æ¸¸æˆ" è¿›å…¥æˆ˜åœº', '#6a5acd');
            } else if (currentState === GAME_STATE.GAME_OVER) {
                drawOverlay('æ¸¸æˆç»“æŸ', `åˆ†æ•°: ${score} - æŒ‰ "å¼€å§‹æ¸¸æˆ" é‡è¯•`, '#ff4500');
            } else if (currentState === GAME_STATE.WIN) {
                drawOverlay('èƒœåˆ©!', `åˆ†æ•°: ${score} - æ­å–œä½ å‡»è´¥äº†é¢†ä¸»!`, '#00ff00');
            }
        }

        // --- ç»˜åˆ¶è¦†ç›–å±‚æ–‡æœ¬ ---
        function drawOverlay(title, message, color) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            ctx.fillStyle = color;
            ctx.font = 'bold 48px "Press Start 2P"';
            ctx.shadowColor = color;
            ctx.shadowBlur = 20;
            ctx.fillText(title, GAME_WIDTH / 2, GAME_HEIGHT / 2 - 40);

            ctx.fillStyle = '#e0e0e0';
            ctx.font = '20px "Press Start 2P"';
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.shadowBlur = 10;
            ctx.fillText(message, GAME_WIDTH / 2, GAME_HEIGHT / 2 + 20);

            ctx.shadowBlur = 0; // é‡ç½®é˜´å½±
            ctx.textAlign = 'left';
            ctx.textBaseline = 'alphabetic';
        }

        // --- æ¸¸æˆç»“æŸ / èƒœåˆ© ---
        function gameOver() {
            currentState = GAME_STATE.GAME_OVER;
        }

        function gameWin() {
            currentState = GAME_STATE.WIN;
        }

        // --- æ›´æ–°UIæ˜¾ç¤º ---
        function updateUI() {
            scoreDisplay.textContent = score;
            livesDisplay.textContent = lives;
        }

        // --- ä¸»æ¸¸æˆå¾ªç¯ ---
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // --- äº‹ä»¶ç›‘å¬ ---
        document.addEventListener('keydown', e => { keys[e.key] = true; });
        document.addEventListener('keyup', e => { keys[e.key] = false; });

        startBtn.addEventListener('click', () => {
            if (currentState === GAME_STATE.MENU || currentState === GAME_STATE.GAME_OVER || currentState === GAME_STATE.WIN) {
                initGame();
            }
        });

        modeSelectBtn.addEventListener('click', () => {
            if (gameMode === 'normal') {
                gameMode = 'hard';
                modeSelectBtn.textContent = 'æ¨¡å¼: å›°éš¾';
                modeSelectBtn.classList.add('active');
            } else {
                gameMode = 'normal';
                modeSelectBtn.textContent = 'æ¨¡å¼: æ™®é€š';
                modeSelectBtn.classList.remove('active');
            }
            // å¦‚æœåœ¨èœå•ç•Œé¢ï¼Œåˆ™æ›´æ–°éš¾åº¦æ˜¾ç¤ºï¼Œå¦åˆ™ç­‰å¾…ä¸‹æ¬¡æ¸¸æˆ
            if (currentState === GAME_STATE.MENU) {
                // ä¸åšé¢å¤–å¤„ç†ï¼Œå› ä¸ºinitGameä¼šæ ¹æ®modeé‡æ–°è®¾ç½®
            }
        });

        cheatBtn.addEventListener('click', () => {
            isCheating = !isCheating;
            if (isCheating) {
                cheatBtn.textContent = 'ä½œå¼Šæ¨¡å¼ (å¼€)';
                cheatBtn.classList.add('active');
                // ç«‹å³æ¿€æ´»ä½œå¼Šèƒ½åŠ›
                playerAbility.invincible = true;
                playerAbility.rapidFire = true;
                playerAbility.oneHitKill = true;
            } else {
                cheatBtn.textContent = 'ä½œå¼Šæ¨¡å¼ (å…³)';
                cheatBtn.classList.remove('active');
                // å…³é—­ä½œå¼Šèƒ½åŠ›
                playerAbility.invincible = false;
                playerAbility.rapidFire = false;
                playerAbility.oneHitKill = false;
            }
            // ä½œå¼Šæ¨¡å¼ä¸é‡ç½®è®¡æ—¶å™¨ï¼Œåªå¼€å…³èƒ½åŠ›
            playerAbility.rapidFireTimer = 0;
            playerAbility.multiShotTimer = 0;
        });
        
        // --- å¯åŠ¨æ¸¸æˆ ---
        // ç¡®ä¿DOMåŠ è½½å®Œæˆåå†å¼€å§‹
        window.onload = () => {
            generateStars(); // é¢„ç”Ÿæˆæ˜Ÿç©º
            gameLoop(); // å¼€å§‹æ¸¸æˆå¾ªç¯
        };

    </script>
</body>
</html>
